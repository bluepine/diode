
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Action Processors Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../UsageWithReact.html" />
    
    
    <link rel="prev" href="PotCollection.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../usage/">
            
                <a href="../usage/">
            
                    
                    Usage
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../usage/ApplicationModel.html">
            
                <a href="../usage/ApplicationModel.html">
            
                    
                    Application Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../usage/Actions.html">
            
                <a href="../usage/Actions.html">
            
                    
                    Actions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../usage/Handlers.html">
            
                <a href="../usage/Handlers.html">
            
                    
                    Action Handlers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../usage/Views.html">
            
                <a href="../usage/Views.html">
            
                    
                    Views
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../usage/Effects.html">
            
                <a href="../usage/Effects.html">
            
                    
                    Async Effects
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Advanced Topics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="Pot.html">
            
                <a href="Pot.html">
            
                    
                    Async Model Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="PotActions.html">
            
                <a href="PotActions.html">
            
                    
                    Stateful Actions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="PotCollection.html">
            
                <a href="PotCollection.html">
            
                    
                    Async Virtual Collections
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.4" data-path="ActionProcessors.html">
            
                <a href="ActionProcessors.html">
            
                    
                    Action Processors
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../UsageWithReact.html">
            
                <a href="../UsageWithReact.html">
            
                    
                    Usage with React
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../examples/">
            
                <a href="../examples/">
            
                    
                    Examples
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Action Processors</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="action-processors">Action Processors</h1>
<p><img src="../images/action-processors.png" style="float: right; padding: 10px" ;=""></p>
<p>Sometimes you need to add a new aspect to action processing requiring access to all dispatched actions. Diode provides an extension mechanism to get in between
dispatching an action and handling it. These <em>action processors</em> may do whatever they want with the incoming action, such as logging, modifying or cancelling
them. The processors can also intercept the return value from the action handler to, for example, capture the modified model into an undo stack.</p>
<h2 id="usage">Usage</h2>
<p>To define an action processor, create a class extending the <code>ActionProcessor[M]</code> trait and override the <code>process</code> function.</p>
<pre><code class="lang-scala"><span class="token keyword">class</span> LoggingProcessor<span class="token punctuation">[</span>M<span class="token punctuation">]</span> <span class="token keyword">extends</span> ActionProcessor<span class="token punctuation">[</span>M<span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> log <span class="token operator">=</span> Vector<span class="token punctuation">.</span>empty<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> process<span class="token punctuation">(</span>dispatch<span class="token operator">:</span> Dispatcher<span class="token punctuation">,</span> action<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">,</span> next<span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token keyword">=&gt;</span> ActionResult<span class="token punctuation">[</span>M<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> ActionResult<span class="token punctuation">[</span>M<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// log the action</span>
    log <span class="token operator">=</span> log <span class="token operator">:</span><span class="token operator">+</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// call the next processor</span>
    next<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Add it to the processing chain with <code>addProcessor</code></p>
<pre><code class="lang-scala"><span class="token keyword">val</span> logProcessor <span class="token operator">=</span> <span class="token keyword">new</span> LoggingProcessor<span class="token punctuation">[</span>RootModel<span class="token punctuation">]</span>
AppCircuit<span class="token punctuation">.</span>addProcessor<span class="token punctuation">(</span>logProcessor<span class="token punctuation">)</span>
</code></pre>
<p>Later you can remove a processor if you don&apos;t need it anymore. </p>
<pre><code class="lang-scala">AppCircuit<span class="token punctuation">.</span>removeProcessor<span class="token punctuation">(</span>logProcessor<span class="token punctuation">)</span>
</code></pre>
<h2 id="use-cases">Use Cases</h2>
<h3 id="batched-action-processing">Batched Action Processing</h3>
<p>To achieve smooth animation in the browser you either need to use CSS transitions or run your animation logic using
<a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame" target="_blank">RAF</a> (<code>requestAnimationFrame</code>). Using RAF guarantees that your code is run at
the refresh rate of the display (typically 60Hz) delivering smooth animation. Additionally RAF provides an accurate time value to calculate your animation
transitions correctly.</p>
<p>In order for your application to utilize RAF you need to update model in the RAF callback and do so for all animations that are currently running. A convenient
way to achieve this is to use a <em>batching</em> action processor that collects dispatched animation actions into a batch and runs them later in the RAF callback.</p>
<p>The <a href="../examples/">RAF example</a> provides a <code>RAFBatcher</code> implementation that does just this. It uses a special marker trait (<code>RAFAction</code>) to identify
which actions should be filtered out and batched. When such an action is encountered, it&apos;s wrapped inside a <code>RAFWrapper</code> and added to the current batch. If not
already done, a RAF callback is requested. When the callback is executed, all batched actions are dispatched and unwrapped when they enter the <code>RAFBatcher</code>&apos;s
<code>process</code> function. The processor also dispatches a special <code>RAFTimeStamp</code> action containing accurate time for the animation actions. Within your Circuit you
should handle this action and update the model with the current timestamp.</p>
<pre><code class="lang-scala"><span class="token keyword">val</span> timestampHandler <span class="token operator">=</span> <span class="token keyword">new</span> ActionHandler<span class="token punctuation">(</span>zoomTo<span class="token punctuation">(</span>_<span class="token punctuation">.</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> handle <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> RAFTimeStamp<span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
      updated<span class="token punctuation">(</span>time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code>RAFBatcher</code> also takes advantage of Circuit&apos;s feature of processing a sequence of actions in one go, calling listeners only after all the actions have
been processed. This improves performance and guarantees correct display of animation results. If your application dispatches a lot of small actions, it may
make sense to use a batching strategy even when no animations are involved.</p>
<h3 id="persisting-application-state">Persisting Application State</h3>
<p>Diode <a href="https://github.com/suzaku-io/diode/tree/master/diode-devtools" target="_blank">devtools</a> project contains a convenient action processor for saving and restoring
application state. This can be useful when encountering a bug in development and wanting to replicate the same application state later, after the code has been
fixed and application reloaded.</p>
<p>The gist of the state persisting action processor is in the <code>process</code> function:</p>
<pre><code class="lang-scala"><span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>dispatch<span class="token operator">:</span> Dispatcher<span class="token punctuation">,</span> action<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">,</span> next<span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token keyword">=&gt;</span> ActionResult<span class="token punctuation">[</span>M<span class="token punctuation">]</span><span class="token punctuation">,</span> currentModel<span class="token operator">:</span> M<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  action <span class="token keyword">match</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> Save<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
      <span class="token comment" spellcheck="true">// pickle and save</span>
      save<span class="token punctuation">(</span>id<span class="token punctuation">,</span> pickle<span class="token punctuation">(</span>currentModel<span class="token punctuation">)</span><span class="token punctuation">)</span>
      ActionResult<span class="token punctuation">.</span>NoChange
    <span class="token keyword">case</span> Load<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
      <span class="token comment" spellcheck="true">// perform state load and unpickling in an effect</span>
      <span class="token keyword">val</span> effect <span class="token operator">=</span> Effect<span class="token punctuation">(</span>load<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> Loaded<span class="token punctuation">(</span>unpickle<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ActionResult<span class="token punctuation">.</span>EffectOnly<span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token keyword">case</span> Loaded<span class="token punctuation">(</span>newModel<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
      <span class="token comment" spellcheck="true">// perform model update</span>
      ActionResult<span class="token punctuation">.</span>ModelUpdate<span class="token punctuation">(</span>newModel<span class="token punctuation">)</span>
    <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span>
      next<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>It simply catches a few predefined actions for saving and loading application state and lets everything else pass through to the next processor. Because loading
happens asynchronously, it is lifted into an <code>Effect</code> and once loading is completed a <code>Loaded</code> action is dispatched. Within <code>Loaded</code> action handler the
application state is actually modified.</p>
<p>The <a href="../examples/">TodoMVC example</a> shows how to use <code>PersistState</code> action processor in an application.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="PotCollection.html" class="navigation navigation-prev " aria-label="Previous page: Async Virtual Collections">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../UsageWithReact.html" class="navigation navigation-next " aria-label="Next page: Usage with React">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Action Processors","level":"1.3.4","depth":2,"next":{"title":"Usage with React","level":"1.4","depth":1,"path":"UsageWithReact.md","ref":"UsageWithReact.md","articles":[]},"previous":{"title":"Async Virtual Collections","level":"1.3.3","depth":2,"path":"advanced/PotCollection.md","ref":"advanced/PotCollection.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"3.2.x","theme":"default","variables":{"version":"1.1.1"},"plugins":["editlink","prism","-highlight","github"],"pluginsConfig":{"editlink":{"label":"Edit This Page","multilingual":false,"base":"https://github.com/suzaku-io/diode/tree/master/doc"},"github":{"url":"https://github.com/suzaku-io/diode/"},"prism":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"advanced/ActionProcessors.md","mtime":"2017-01-25T22:22:38.770Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-01-25T22:22:52.104Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-editlink/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

